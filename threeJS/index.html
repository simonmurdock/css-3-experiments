<html>
<head>
	<link rel="stylesheet" href="css/css.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/three.min.js"></script>
	<script type="text/javascript" src="js/threex.keyboardstate.js"></script>
	<script type="text/javascript" src="http://threejs.org/examples/js/controls/OrbitControls.js"></script>
	<script type="text/javascript" src="js/js.js"></script>
	<script type="text/javascript" src="js/stats.js"></script>
	<script type="text/javascript" src="js/shaders/CopyShader.js"></script>
	<script type="text/javascript" src="js/shaders/RGBShiftShader.js"></script>
	<script type="text/javascript" src="js/postprocessing/EffectComposer.js"></script>
	<script type="text/javascript" src="js/postprocessing/RenderPass.js"></script>
	<script type="text/javascript" src="js/postprocessing/MaskPass.js"></script>
	<script type="text/javascript" src="js/postprocessing/ShaderPass.js"></script>
</head>
<body>

<div id='overlay'>
	<div id='startButton' class='centered'>Click to start</div>
</div>
<div id='hud'>
	<span id='cameraPos'></span><br/>
	<span id='mouseInput'></span>
</div>
<div id='container'></div>

<script>

	function FpsGame () {

		self = this,
	    this.materialLibrary = null,
	    this.renderer = new THREE.WebGLRenderer(),
	    this.composer = new THREE.EffectComposer(this.renderer),
	    this.scene = new THREE.Scene(),
	    this.camera = new THREE.PerspectiveCamera(60, window.innerWidth/ window.innerHeight, 0.1, 10000),
	    this.pitchObject = {x:0},
	    this.yawObject = {y:0},
	    this.sunlight = new THREE.DirectionalLight(0xdfebff, 1),
	    this.stats = new Stats(),
	    this.gun = {},
	    this.paused = true,

	    self.buildMaterialLibrary = function() {

			var maxAnisotropy = this.renderer.getMaxAnisotropy();

			var sandTexture = THREE.ImageUtils.loadTexture('/threejs/css/img/sand.jpg');
				sandTexture.wrapS = THREE.RepeatWrapping;
				sandTexture.wrapT = THREE.RepeatWrapping;
				sandTexture.repeat.set( 3, 3 );

			var sandBump = THREE.ImageUtils.loadTexture('/threejs/css/img/sand_bump.jpg');
				sandBump.wrapS = THREE.RepeatWrapping;
				sandBump.wrapT = THREE.RepeatWrapping;
				sandBump.anisotropy = maxAnisotropy;
				sandBump.repeat.set( 3, 3 );

			var crateTexture = THREE.ImageUtils.loadTexture('/threejs/css/img/crate.jpg');
				crateTexture.anisotropy = maxAnisotropy;

			var crateBump = THREE.ImageUtils.loadTexture('/threejs/css/img/crate_bump.jpg');
				crateBump.anisotropy = maxAnisotropy;

			materialLibrary = {
					crateMaterial:new THREE.MeshPhongMaterial({ 
					map:crateTexture,
					bumpMap: crateBump,
					bumpScale:0.1,
					specular: new THREE.Color(0x483527),
					shininess: 10
				}),
					sandMaterial:new THREE.MeshPhongMaterial({ 
					map:sandTexture,
					bumpMap: sandBump,
					bumpScale:0.1,
					specular: new THREE.Color(0xeedfc5),
					shininess: 500
				})
			};

			return materialLibrary;
		},

		self.buildGeometry = function (scene) {

			var geometry = new THREE.BoxGeometry(16,16,16);
			var cube = new THREE.Mesh(geometry,materialLibrary.crateMaterial);
				cube.castShadow = true;
				cube.receiveShadow = true;
				cube.position.y = 8;
				cube.position.z = -32;

			scene.add(cube);

			var smallGeometry = new THREE.BoxGeometry(8,8,8);
			var cube2 = new THREE.Mesh(smallGeometry,materialLibrary.crateMaterial);
				cube2.castShadow = true;
				cube2.receiveShadow = true;
				cube2.position.y = 4;
				cube2.position.x = 32;
				cube2.position.z = -46;

			scene.add(cube2);

			var gunGeometry = new THREE.BoxGeometry(0.3,0.3,6);
				self.gun = new THREE.Mesh(gunGeometry,materialLibrary.crateMaterial);
				self.gun.castShadow = true;
				self.gun.receiveShadow = true;

			scene.add(self.gun);

		    var plane = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), materialLibrary.sandMaterial);
		    	plane.rotation.x = -Math.PI / 2;
		    	plane.receiveShadow = true;

		    scene.add(plane);

		    var plane2 = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), materialLibrary.sandMaterial);
		    	plane2.position.z = -50;
		    	plane2.position.y = 50;
		    	plane2.receiveShadow = true;

		    scene.add(plane2);
		},

	    self.buildLighting = function(scene){

			var ambientLight = new THREE.AmbientLight(0x666666);
		    this.sunlight.position.set(300, 400, 90);
		    this.sunlight.castShadow = true;
		    this.sunlight.shadowMapWidth = 4096;
		    this.sunlight.shadowMapHeight = 4096;
		    //sunlight.shadowCameraVisible = true;

			this.scene.add(ambientLight);
			this.scene.add(this.sunlight);

			this.composer.addPass( new THREE.RenderPass( this.scene, this.camera ) );

			var rgbEffect = new THREE.ShaderPass( THREE.RGBShiftShader );
			rgbEffect.uniforms[ 'amount' ].value = 0.0009;
			rgbEffect.renderToScreen = true;
			this.composer.addPass( rgbEffect );
		},

	    self.drawDebugMenu = function(scene){

			$('#cameraPos').html('X: ' 			+ self.camera.position.x.toFixed(2) 
						  + '<br/>Y: ' 			+ self.camera.position.y.toFixed(2)
						  + '<br/>Z: ' 			+ self.camera.position.z.toFixed(2)
						  + '<br/>rotation X: ' + self.camera.rotation.x.toFixed(2)
						  + '<br/>rotation Y: ' + self.camera.rotation.y.toFixed(2));
		},

		self.drawWeapon = function(){

			self.gun.rotation.order = 'ZYX';
			//self.gun.rotation.x = self.camera.rotation.x;
			///self.gun.rotation.y = self.camera.rotation.y;
			self.gun.rotation.setFromRotationMatrix(self.camera.matrix);
			self.gun.position.y = self.camera.position.y;
			self.gun.position.x = self.camera.position.x+2;
			// self.gun.rotation.x = self.pitchObject.x;
			// self.gun.rotation.y = self.yawObject.y;
			// self.gun.position.y = self.camera.position.y;
			//self.gun.rotation.setFromRotationMatrix(camera.matrix);
		},

		self.handleMouseMove = function ( event ) {

			var PI_2 = Math.PI / 2;
			var movementX = event.movementX;
			var movementY = event.movementY;

			$('#mouseInput').html('mouseMovementX: ' + movementX + '<br/>mouseMovementY: ' + movementY);

			self.yawObject.y -= movementX * 0.002;
			self.pitchObject.x -= movementY * 0.002;
			
			self.pitchObject.x = Math.max( - PI_2, Math.min( PI_2, self.pitchObject.x ) );

			self.camera.rotation.order = 'ZYX';
			self.camera.rotation.x = self.pitchObject.x;
			self.camera.rotation.y = self.yawObject.y;
		},

		self.handleKeyboardInput = function ( event ) {
			
		},

		self.init = function(){

			this.renderer.setSize( window.innerWidth,  window.innerHeight);
			this.renderer.shadowMapEnabled = true;
			this.renderer.shadowMapSoft = true;
			this.renderer.setClearColor( 0xBFEFFF, 1 );

			$('#container').append(this.renderer.domElement);

			this.stats.setMode(0); // 0: fps, 1: ms

			// Align top-left
			this.stats.domElement.style.position = 'absolute';
			this.stats.domElement.style.left = '0px';
			this.stats.domElement.style.top = '0px';
			document.body.appendChild(this.stats.domElement);

			this.buildMaterialLibrary();
			this.buildGeometry(this.scene);
			this.buildLighting(this.scene);

			$('#startButton').click(function(){
				document.body.requestPointerLock();
				$('#overlay').hide();
				x.paused = false;
			});

			document.addEventListener( 'mousemove', self.handleMouseMove, false );
			self.camera.translateY(10);
		}
	}

	var x = new FpsGame;
	x.init();

	x.update = function () {
		x.stats.begin();
		x.drawDebugMenu();
		x.drawWeapon();

		setTimeout( function() {
        	requestAnimationFrame(x.update);   
    	}, 1000 / (x.paused ? 2 : 50));

		x.renderer.render(x.scene, x.camera);
		//x.composer.render();

		x.stats.end();
	};

	x.update();

</script>
</body>
</html>