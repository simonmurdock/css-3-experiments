
<html>
<head>
  <link rel="stylesheet" href="css/css.css">
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/linear_partition.js"></script>
  <script type="text/javascript" src="js/knockout-3.2.0.js"></script>
  <title>dynamic gallery</title>
</head>
<body>
  <div id='pageLayout'>
  	<div id='buttons'>
  		<input type='button' value='Add a photo' id='addAssetButton'></input>
  		<input type='button' value='Remove a photo' id='removeAssetButton'></input>
  	</div>
  	<div id='leftColumn'></div>
  	<div id='rightColumn'>
		<div id='container' data-bind="foreach: photos()">
	   		<div class="galleryPic" data-bind="style:{ width:displayWidthCss(), height:displayHeightCss(), backgroundImage:url() }"></div>
		</div>
  	</div>
  </div>

<script>

	function PhotoViewModel(name, width, height) {

		this.name = name;
		this.height = height;
		this.width = width;
		this.aspectRatio = width/height;
		this.displayWidth = ko.observable(100.0);
		this.displayHeight = ko.observable(100.0);
		this.displayWidthCss = ko.pureComputed(function() {
			return this.displayWidth() + 'px';
		}, this);
		this.displayHeightCss = ko.pureComputed(function() {
			return this.displayHeight() + 'px';
		}, this);
		this.url = function() { return 'url(css/img/' + name + '.png)'}
	}

	function galleryViewModel(photos) {

	    var self = this;

	    self.init = function() {

			self.photos = photos;

			window.onresize = function(event) {
				vm.calculateFit();
			}

			self.calculateFit();
	    }

		self.resize = function(photo, maxWidth, maxHeight) {

		    var ratio = maxHeight / photo.height;

		    photo.displayWidth(Math.floor(photo.width*ratio));
		    photo.displayHeight(Math.floor(maxHeight));
		}

		self.calculateFit = function(){

			self.weights = [];
			self.rowBuffer = [];
			self.overallIndex = 0;
			self.summedWidth = 0;

			for (var i = 0; i < self.photos().length; i++) {
				self.summedWidth += (self.photos()[i].width);
				self.weights.push(self.photos()[i].aspectRatio)
			};

			self.viewportWidth = document.getElementById("container").clientWidth;
			self.rows = Math.round((self.summedWidth/ self.viewportWidth/2));
			self.partition = linearPartition(self.weights, self.rows);

			for (var r = 0; r < self.partition.length; r++) {
				
				self.row = self.partition[r];
				self.rowSummedAspectRatios = 0;
				self.rowSummedWidth = 0;
				self.rowBuffer = [];

				for (var i = 0; i < self.row.length; i++) {
					self.rowBuffer.push(self.photos()[self.overallIndex++]);
				};

				for (var z = 0; z < self.rowBuffer.length; z++) {
					self.rowSummedAspectRatios += self.rowBuffer[z].aspectRatio;
				};

				for (var i = 0; i < self.rowBuffer.length; i++) {
					self.resize(self.rowBuffer[i],self.viewportWidth / self.rowSummedAspectRatios * self.rowBuffer[i].aspectRatio, self.viewportWidth / self.rowSummedAspectRatios);
				}
			};
		}

		self.init();
	}

	var photoSet = new ko.observableArray([
		new PhotoViewModel(1,181,323),
		new PhotoViewModel(2,312,153),
		new PhotoViewModel(3,1282,1660),
		new PhotoViewModel(4,297,226),
		new PhotoViewModel(5,374,245),
		new PhotoViewModel(6,512,512),
		new PhotoViewModel(8,441,286),
		new PhotoViewModel(9,1600,1067),
		new PhotoViewModel(10,277,186),
		new PhotoViewModel(11,1298,1678),
		new PhotoViewModel(12,1298,1678),
		new PhotoViewModel(1,181,323),
		new PhotoViewModel(2,312,153),
		new PhotoViewModel(3,1282,1660),
		new PhotoViewModel(1,181,323),
		new PhotoViewModel(2,312,153),
		new PhotoViewModel(6,512,512),
		new PhotoViewModel(8,441,286),
		new PhotoViewModel(9,1600,1067),
		new PhotoViewModel(10,277,186),
		new PhotoViewModel(3,1282,1660),
		new PhotoViewModel(4,297,226),
		new PhotoViewModel(6,512,512),
		new PhotoViewModel(8,441,286),
		new PhotoViewModel(10,277,186),
		new PhotoViewModel(5,374,245),
		new PhotoViewModel(6,512,512),
		new PhotoViewModel(8,441,286),
		new PhotoViewModel(9,1600,1067),
		new PhotoViewModel(10,277,186),
		new PhotoViewModel(11,1298,1678),
		new PhotoViewModel(4,297,226),
		new PhotoViewModel(5,374,245),
		new PhotoViewModel(6,512,512),
		new PhotoViewModel(8,441,286),
		new PhotoViewModel(9,1600,1067),
		new PhotoViewModel(10,277,186),
		new PhotoViewModel(11,1298,1678),
		new PhotoViewModel(12,1298,1678)
	]);

	var vm;

	$(document).ready(function() {

		vm = new galleryViewModel(photoSet);
		ko.applyBindings(vm);

		$('#addAssetButton').on('click', function(){

			vm.photos.push(new PhotoViewModel(12,1298,1678));
			vm.calculateFit()
		});

		$('#removeAssetButton').on('click', function(){

			vm.photos.pop();
			vm.calculateFit();
		});

	});

</script>
</body>
</html>