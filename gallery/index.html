
<html>
	<head>
		<link rel="stylesheet" href="css/css.css">
		<script type="text/javascript" src="js/jquery.js"></script>
		<script type="text/javascript" src="js/linear_partition.js"></script>
		<script type="text/javascript" src="js/knockout-3.2.0.js"></script>
		<title>dynamic gallery</title>
	</head>
<body>
<div id='pageLayout'>
	<div id='leftColumn'>
		<input type='button' value='Add a page' id='addAssetButton'></input>
	</div>
	<div id='rightColumn'>
		<div id='container' data-bind='foreach: pages()'>
			<div id='pageContainer' data-bind='foreach: photos()'>
				<div class='asset' data-bind='style:{ width:displayWidthCss(), height:displayHeightCss(), backgroundImage:url() }'>
					<div class='assetPopup' data-bind="style:{ backgroundImage:url() }">
						<div class='infoBar'>
							<span class='name'>document name</span>
							<div class='clear'></div>
							<span class='created'>Created Monday 1st september 2014</span>
							<span class='code'>A C AA EZ 0001</span>
						</div>
						<div class='infoPanel'>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec in tincidunt nibh. Sed dignissim dictum purus sed rutrum. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Aliquam tincidunt pharetra commodo. Fusce posuere lobortis pharetra.</div>
						<div class='buttonBar'>
							<span class='button'>Info</span>
							<span class='button'>Edit</span>
							<span class='button'>Share</span>
							<span class='button'>Download</span>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<script>

	function PageViewModel() {
		var self = this;
		self.photos = ko.observableArray();
	}

	function AssetViewModel(name, width, height) {

		this.name = name;
		this.height = height;
		this.width = width;
		this.aspectRatio = width/height;
		this.displayWidth = ko.observable(100.0);
		this.displayHeight = ko.observable(100.0);

		this.displayWidthCss = ko.pureComputed(function() {
			return this.displayWidth() + 'px';
		}, this);

		this.displayHeightCss = ko.pureComputed(function() {
			return this.displayHeight() + 'px';
		}, this);

		this.url = function() { return 'url(css/img/' + name + '.png)'}
	}

	function GalleryViewModel() {

	    var self = this;
		self.pages = ko.observableArray();

	    self.init = function() {

			self.calculateFit();

			window.onresize = function(event) {
				vm.calculateFit();
			}
	    }

	    self.addPage = function(page){

	    	self.pages.push(page);
	    	self.calculateFit();
	    }

		self.resize = function(photo, maxWidth, maxHeight) {

		    var ratio = maxHeight / photo.height;

		    photo.displayWidth(Math.floor(photo.width*ratio));
		    photo.displayHeight(Math.floor(maxHeight));
		}

		self.calculateFit = function(){

			for (var p = 0; p < self.pages().length; p++) {
				
				self.summedWidth = 0;
				self.overallIndex = 0;
				self.weights = [];
				self.rowBuffer = [];

				self.photos = self.pages()[p].photos;

				for (var i = 0; i < self.photos().length; i++) {
					self.summedWidth += (self.photos()[i].width);
					self.weights.push(self.photos()[i].aspectRatio)
				};

				self.viewportWidth = document.getElementById("container").clientWidth;
				self.rows = Math.round((self.summedWidth/self.viewportWidth)/2);
				self.partition = linearPartition(self.weights, self.rows);

				for (var r = 0; r < self.partition.length; r++) {
					
					self.row = self.partition[r];
					self.rowSummedAspectRatios = 0;
					self.rowSummedWidth = 0;
					self.rowBuffer = [];

					for (var i = 0; i < self.row.length; i++) {
						self.rowBuffer.push(self.photos()[self.overallIndex++]);
					};

					for (var z = 0; z < self.rowBuffer.length; z++) {
						self.rowSummedAspectRatios += self.rowBuffer[z].aspectRatio;
					};

					for (var i = 0; i < self.rowBuffer.length; i++) {
						self.resize(self.rowBuffer[i],self.viewportWidth / self.rowSummedAspectRatios * self.rowBuffer[i].aspectRatio, self.viewportWidth / self.rowSummedAspectRatios);
					}
				};
			}
		}

		self.init();
	}

	var vm;

	$(document).ready(function() {

		var testPage = new PageViewModel();
			testPage.photos.push(new AssetViewModel(1,323,180));
			testPage.photos.push(new AssetViewModel(2,1698,1131));
			testPage.photos.push(new AssetViewModel(3,1282,1660));
			testPage.photos.push(new AssetViewModel(4,297,226));
			testPage.photos.push(new AssetViewModel(5,374,245));
			testPage.photos.push(new AssetViewModel(6,1024,616));
			testPage.photos.push(new AssetViewModel(8,441,286));
			testPage.photos.push(new AssetViewModel(9,1600,1067));
			testPage.photos.push(new AssetViewModel(10,277,186));
			testPage.photos.push(new AssetViewModel(11,1298,1678));
			testPage.photos.push(new AssetViewModel(13,1280,851));

		vm = new GalleryViewModel();
		vm.addPage(testPage);
		ko.applyBindings(vm);

		$('#addAssetButton').on('click', function(){

			var testPage = new PageViewModel();
			testPage.photos.push(new AssetViewModel(3,1282,1660));
			testPage.photos.push(new AssetViewModel(4,297,226));
			testPage.photos.push(new AssetViewModel(1,1298,1678));
			testPage.photos.push(new AssetViewModel(2,1698,1131));
			testPage.photos.push(new AssetViewModel(1,181,323));
			testPage.photos.push(new AssetViewModel(1,277,186));
			testPage.photos.push(new AssetViewModel(5,374,245));
			testPage.photos.push(new AssetViewModel(6,512,512));
			testPage.photos.push(new AssetViewModel(8,441,286));
			testPage.photos.push(new AssetViewModel(9,1600,1067));
			testPage.photos.push(new AssetViewModel(12,1298,1678));
			vm.addPage(testPage);
			vm.calculateFit();
		});

	});

</script>
</body>
</html>