
<html>
<head>
  <link rel="stylesheet" href="css/css.css">
  <script type="text/javascript" src="js/jquery.js"></script>
  <script type="text/javascript" src="js/linear_partition.js"></script>
  <script type="text/javascript" src="js/knockout-3.2.0.js"></script>
  <title>dynamic gallery</title>
</head>
<body>
  <div id='pageLayout'>
  	<div id='leftColumn'>Left Column</div>
  	<div id='rightColumn'>
		<div id='container' data-bind="foreach: photos">
	   		<div class="galleryPic" data-bind="style:{ width:displayWidthCss(), height:displayHeightCss(), backgroundImage:url() }">
	   		</div>
		</div>
  	</div>
  </div>

<script>
	var vm;

	function PhotoViewModel(name, width, height) {

		this.name = name;
		this.height = height;
		this.width = width;
		this.aspectRatio = width/height;
		this.displayWidth = ko.observable(100.0);
		this.displayHeight = ko.observable(100.0);
		this.displayWidthCss = ko.pureComputed(function() {
			return this.displayWidth() + 'px';
		}, this);
		this.displayHeightCss = ko.pureComputed(function() {
			return this.displayHeight() + 'px';
		}, this);
		this.url = function() { return 'url(css/img/' + name + '.png)'}

	}

	function galleryViewModel(photos) {

	    var self = this;

	    self.init = function() {

			self.photos = photos;
	    	self.summedWidth = 0;

		    for (var i = 0; i < self.photos.length; i++) {
				self.summedWidth += (self.photos[i].width);
			};
	    }

		self.resize = function(photo, maxWidth, maxHeight) {

		    var ratio = maxHeight / photo.height;

		    photo.displayWidth(Math.floor(photo.width*ratio));
		    photo.displayHeight(Math.floor(maxHeight));
		}

		self.calculateFit = function(){

			viewportWidth = document.getElementById("container").clientWidth-1;
			// dynamically adjust row count based on 'viewport' width
			rows = Math.round((self.summedWidth/ viewportWidth)/2);

			weights = [];
			rowBuffer = [];
			overallIndex = 0;
			var galleryHtml = '';

			for (var z = 0; z < self.photos.length; z++) {
				weights.push(self.photos[z].aspectRatio)
			};

			partition = linearPartition(weights, rows);

			for (var r = 0; r < partition.length; r++) {
				
				var row = partition[r];
				var summedAspectRatios = 0;
				rowBuffer = [];

				for (var i = 0; i < row.length; i++) {
					rowBuffer.push(self.photos[overallIndex++]);
				};

				for (var z = 0; z < rowBuffer.length; z++) {
					summedAspectRatios += rowBuffer[z].aspectRatio;
				};

				for (var i = 0; i < rowBuffer.length; i++) {
					var photo = rowBuffer[i];
					
					//to prevent the 'bug' where a single column results in a larger height that expected it is because we are using a ratio like 1:2.
					self.resize(photo,viewportWidth / summedAspectRatios * photo.aspectRatio, viewportWidth / summedAspectRatios);
				}
			};
		}

		self.init();
		self.calculateFit();
	}

	photos = new Array();
	photos.push(new PhotoViewModel(1,181,323));
	photos.push(new PhotoViewModel(2,312,153));
	photos.push(new PhotoViewModel(3,1282,1660));
	photos.push(new PhotoViewModel(4,297,226));
	photos.push(new PhotoViewModel(5,374,245));
	photos.push(new PhotoViewModel(6,512,512));
	photos.push(new PhotoViewModel(8,441,286));
	photos.push(new PhotoViewModel(9,1600,1067));
	photos.push(new PhotoViewModel(10,277,186));
	photos.push(new PhotoViewModel(11,1298,1678));
	photos.push(new PhotoViewModel(12,1298,1678));

	$(document).ready(function() {

		vm = new galleryViewModel(photos);
		ko.applyBindings(vm);

		window.onresize = function(event) {
			vm.calculateFit();
		};

	});

</script>
</body>
</html>